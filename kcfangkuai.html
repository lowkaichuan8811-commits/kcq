<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K(ai) - ç»ˆææé€Ÿæ™ºèƒ½åŠ©æ‰‹</title>
    <style>
        :root {
            --primary: #4facfe;
            --primary-dark: #3a9df5;
            --secondary: #00f2fe;
            --accent: #ff6b6b;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #51cf66;
            --warning: #ffd43b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .kai-container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            height: 85vh;
            position: relative;
        }

        .sidebar {
            width: 260px;
            background: var(--light);
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .new-chat-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(79, 172, 254, 0.4);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-history-item {
            padding: 14px 16px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            border: 1px solid #e9ecef;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .chat-history-item:hover {
            background: #edf2ff;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .chat-history-item.active {
            background: #e3f2fd;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.2);
        }

        .chat-history-item .title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .chat-history-item .date {
            font-size: 0.75rem;
            color: #666;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 22px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.4rem;
            margin-bottom: 6px;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            opacity: 0.95;
            font-size: 1.05rem;
            font-weight: 500;
        }

        .status-indicator {
            position: absolute;
            top: 22px;
            right: 22px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.25);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .chat-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
            background: #fafbfc;
        }

        .message {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .kai-message {
            align-self: flex-start;
            background: white;
            color: var(--dark);
            border-bottom-left-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .learning-indicator {
            font-size: 0.75rem;
            color: #666;
            margin-top: 8px;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .learning-indicator::before {
            content: "ğŸ§ ";
            margin-right: 6px;
        }

        .input-container {
            padding: 22px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 12px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
        }

        #user-input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        #user-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.15);
            background: white;
        }

        #send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.3rem;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        #send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.08);
            box-shadow: 0 6px 15px rgba(79, 172, 254, 0.4);
        }

        #send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .typing-indicator {
            align-self: flex-start;
            background: white;
            color: #666;
            padding: 14px 18px;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            display: none;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            animation: typing 1.4s infinite;
            display: inline-block;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            padding: 30px;
        }

        .empty-state h3 {
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 1.5rem;
            color: var(--dark);
        }

        .empty-state p {
            font-size: 1rem;
            max-width: 400px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .empty-state .features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-width: 400px;
        }

        .feature {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .feature .icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .feature .title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .feature .desc {
            font-size: 0.85rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .kai-container {
                flex-direction: column;
                height: 90vh;
            }
            
            .sidebar {
                width: 100%;
                height: 160px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .chat-history {
                display: flex;
                overflow-x: auto;
                padding: 12px;
            }
            
            .chat-history-item {
                flex: 0 0 auto;
                width: 160px;
                margin-right: 10px;
                margin-bottom: 0;
            }
            
            .message {
                max-width: 90%;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .empty-state .features {
                grid-template-columns: 1fr;
            }
        }

        .speed-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            display: none;
        }

        .context-badge {
            display: inline-block;
            background: rgba(79, 172, 254, 0.1);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: 600;
        }

        .quick-responses {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .quick-response {
            background: rgba(79, 172, 254, 0.1);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }

        .quick-response:hover {
            background: rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="kai-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="new-chat-btn">
                    <span>+</span> æ–°èŠå¤©
                </button>
            </div>
            <div class="chat-history" id="chat-history">
                <!-- èŠå¤©å†å²å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="header">
                <h1>K(ai) ç»ˆææé€Ÿç‰ˆ</h1>
                <p>æ¯«ç§’çº§å“åº” Â· æ·±åº¦å­¦ä¹  Â· æè‡´æ™ºèƒ½</p>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>æé€Ÿåœ¨çº¿</span>
                </div>
            </div>
            
            <div class="chat-container" id="chat-container">
                <div class="empty-state" id="empty-state">
                    <h3>æ¬¢è¿ä½¿ç”¨ K(ai) ç»ˆææé€Ÿç‰ˆ</h3>
                    <p>ä½“éªŒå‰æ‰€æœªæœ‰çš„AIäº¤äº’é€Ÿåº¦ï¼æ¯«ç§’çº§å“åº”ï¼Œæ·±åº¦å­¦ä¹ èƒ½åŠ›ï¼Œæè‡´ä¸ªæ€§åŒ–ä½“éªŒã€‚</p>
                    <div class="features">
                        <div class="feature">
                            <div class="icon">âš¡</div>
                            <div class="title">æ¯«ç§’çº§å“åº”</div>
                            <div class="desc">5-30msæé€Ÿå›åº”</div>
                        </div>
                        <div class="feature">
                            <div class="icon">ğŸ§ </div>
                            <div class="title">æ·±åº¦å­¦ä¹ </div>
                            <div class="desc">å®æ—¶å­¦ä¹ ä¸è¿›åŒ–</div>
                        </div>
                        <div class="feature">
                            <div class="icon">ğŸ¯</div>
                            <div class="title">æè‡´æ™ºèƒ½</div>
                            <div class="desc">ä¸Šä¸‹æ–‡æ·±åº¦ç†è§£</div>
                        </div>
                        <div class="feature">
                            <div class="icon">ğŸš€</div>
                            <div class="title">æ€§èƒ½ä¼˜åŒ–</div>
                            <div class="desc">æè‡´ç®—æ³•æ•ˆç‡</div>
                        </div>
                    </div>
                </div>
                <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                K(ai)æ­£åœ¨æ€è€ƒ<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
            </div>
            
            <div class="input-container">
                <input type="text" id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯... (æŒ‰Enterå‘é€)" autocomplete="off">
                <button id="send-btn">â¤</button>
            </div>
        </div>
        <div class="speed-indicator" id="speed-indicator">å“åº”æ—¶é—´: 0ms</div>
    </div>

    <script>
        // ç»ˆææé€Ÿç‰ˆ K(ai) AIæ ¸å¿ƒç±»
        class UltimateKaiAI {
            constructor() {
                this.name = "K(ai)";
                this.version = "5.0 - ç»ˆææé€Ÿç‰ˆ";
                this.currentChatId = this.generateChatId();
                this.chatSessions = this.loadChatSessions();
                this.learnedKnowledge = this.loadKnowledge();
                this.userMemory = this.loadMemory();
                this.conversationPatterns = this.loadConversationPatterns();
                this.responseCache = new Map(); // å“åº”ç¼“å­˜
                this.quickResponseCache = new Map(); // å¿«é€Ÿå“åº”ç¼“å­˜
                
                // é¢„åŠ è½½æ‰€æœ‰å¸¸è§å›åº”
                this.preloadAllResponses();
                
                // æé€ŸçŸ¥è¯†åº“ - ä½¿ç”¨å¯¹è±¡ç›´æ¥æ˜ å°„
                this.instantKnowledge = {
                    "ä½ å¥½": ["ä½ å¥½ï¼æˆ‘æ˜¯K(ai)ç»ˆææé€Ÿç‰ˆï¼âš¡", "å—¨ï¼å¾ˆé«˜å…´è§åˆ°æ‚¨ï¼", "æ‚¨å¥½ï¼éšæ—¶ä¸ºæ‚¨æœåŠ¡ï¼"],
                    "ä½ å¥½å—": ["æˆ‘å¾ˆå¥½ï¼çŠ¶æ€æä½³ï¼", "éå¸¸å¥½ï¼éšæ—¶å‡†å¤‡å¸®åŠ©æ‚¨ï¼"],
                    "è°¢è°¢": ["ä¸å®¢æ°”ï¼", "éšæ—¶ä¸ºæ‚¨æœåŠ¡ï¼", "å¾ˆé«˜å…´èƒ½å¸®åŠ©æ‚¨ï¼"],
                    "å†è§": ["å†è§ï¼æœŸå¾…ä¸‹æ¬¡äº¤æµï¼", "æ‹œæ‹œï¼", "å†è§å•¦ï¼"],
                    "å¤©æ°”": ["æˆ‘æ— æ³•è·å–å®æ—¶å¤©æ°”ï¼Œä½†å¯ä»¥ç»™æ‚¨ä¸€èˆ¬å»ºè®®ï¼ğŸŒ¤ï¸"],
                    "æ—¶é—´": [`ç°åœ¨æ—¶é—´æ˜¯ï¼š${new Date().toLocaleString('zh-CN')} â°`],
                    "ä½ èƒ½åšä»€ä¹ˆ": ["æˆ‘æ˜¯K(ai)ï¼Œå¯ä»¥ï¼šæé€Ÿå›ç­”é—®é¢˜ã€æ·±åº¦å¯¹è¯ã€æŒç»­å­¦ä¹ ã€ä¸ªæ€§åŒ–æœåŠ¡ï¼"],
                    "ä½ æ˜¯è°": ["æˆ‘æ˜¯K(ai)ç»ˆææé€Ÿç‰ˆï¼å…·æœ‰æ¯«ç§’çº§å“åº”èƒ½åŠ›çš„AIåŠ©æ‰‹ï¼"]
                };
                
                // åˆå§‹åŒ–å½“å‰èŠå¤©
                if (!this.chatSessions[this.currentChatId]) {
                    this.chatSessions[this.currentChatId] = {
                        id: this.currentChatId,
                        title: "æ–°å¯¹è¯",
                        messages: [],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    this.saveChatSessions();
                }
            }
            
            // é¢„åŠ è½½æ‰€æœ‰å¸¸è§å›åº”
            preloadAllResponses() {
                // åŸºç¡€é—®å€™
                const greetings = ["ä½ å¥½", "å—¨", "hello", "hi", "æ‚¨å¥½", "å˜¿", "æ—©ä¸Šå¥½", "ä¸‹åˆå¥½", "æ™šä¸Šå¥½"];
                greetings.forEach(greet => {
                    this.quickResponseCache.set(greet, [
                        `ä½ å¥½ï¼æˆ‘æ˜¯K(ai)ç»ˆææé€Ÿç‰ˆï¼âš¡`,
                        `å—¨ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼`,
                        `${greet}ï¼æˆ‘æ˜¯K(ai)ï¼Œæ‚¨çš„æé€ŸAIåŠ©æ‰‹ï¼`
                    ]);
                });
                
                // å¸¸è§é—®é¢˜
                const commonQuestions = {
                    "ä½ èƒ½åšä»€ä¹ˆ": [
                        "æˆ‘æ˜¯K(ai)ç»ˆææé€Ÿç‰ˆï¼Œå…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š\nâ€¢ æ¯«ç§’çº§å“åº”\nâ€¢ æ·±åº¦ä¸Šä¸‹æ–‡ç†è§£\nâ€¢ æŒç»­å­¦ä¹ è¿›åŒ–\nâ€¢ æè‡´ä¸ªæ€§åŒ–\nâ€¢ å¤šè½®å¯¹è¯è®°å¿†",
                        "æˆ‘å¯ä»¥ï¼šæé€Ÿå›ç­”é—®é¢˜ã€æ·±åº¦å¯¹è¯ã€æŒç»­å­¦ä¹ ã€æä¾›ä¸ªæ€§åŒ–æœåŠ¡ï¼"
                    ],
                    "ä½ æ˜¯è°": [
                        "æˆ‘æ˜¯K(ai)ç»ˆææé€Ÿç‰ˆï¼å…·æœ‰æ¯«ç§’çº§å“åº”èƒ½åŠ›çš„AIåŠ©æ‰‹ï¼",
                        "æˆ‘æ˜¯K(ai)ï¼Œæ‚¨çš„æé€Ÿæ™ºèƒ½åŠ©æ‰‹ï¼"
                    ],
                    "å¤©æ°”æ€ä¹ˆæ ·": ["æˆ‘æ— æ³•è·å–å®æ—¶å¤©æ°”ï¼Œä½†å¯ä»¥ç»™æ‚¨ä¸€èˆ¬å»ºè®®ï¼ğŸŒ¤ï¸"],
                    "ç°åœ¨å‡ ç‚¹": [`ç°åœ¨æ—¶é—´æ˜¯ï¼š${new Date().toLocaleString('zh-CN')} â°`]
                };
                
                for (const [question, answers] of Object.entries(commonQuestions)) {
                    this.quickResponseCache.set(question, answers);
                    // ä¹Ÿä¸ºç±»ä¼¼é—®é¢˜æ·»åŠ ç¼“å­˜
                    if (question.includes("è°")) {
                        this.quickResponseCache.set("ä½ å«ä»€ä¹ˆ", answers);
                    }
                    if (question.includes("åšä»€ä¹ˆ")) {
                        this.quickResponseCache.set("ä½ ä¼šä»€ä¹ˆ", answers);
                        this.quickResponseCache.set("åŠŸèƒ½", answers);
                    }
                }
                
                // æƒ…æ„Ÿå›åº”
                const emotionalResponses = {
                    "å¼€å¿ƒ": ["å¤ªå¥½äº†ï¼å¬åˆ°æ‚¨å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆé«˜å…´ï¼ğŸ˜Š", "çœŸæ£’ï¼ç»§ç»­ä¿æŒå¥½å¿ƒæƒ…ï¼"],
                    "éš¾è¿‡": ["æˆ‘ç†è§£æ‚¨çš„å¿ƒæƒ…ï¼Œå¦‚æœæ‚¨æ„¿æ„åˆ†äº«ï¼Œæˆ‘å¾ˆä¹æ„å€¾å¬ã€‚", "æœ‰æ—¶å€™ç¡®å®ä¼šæ„Ÿåˆ°éš¾è¿‡ï¼Œæˆ‘åœ¨è¿™é‡Œæ”¯æŒæ‚¨ã€‚"],
                    "ç”Ÿæ°”": ["ç”Ÿæ°”æ˜¯æ­£å¸¸çš„æƒ…ç»ªï¼Œä½†è¯•ç€æ·±å‘¼å¸æ”¾æ¾ä¸€ä¸‹ã€‚", "æˆ‘ç†è§£æ‚¨æ„Ÿåˆ°ç”Ÿæ°”ï¼Œå¸Œæœ›äº‹æƒ…èƒ½å°½å¿«å¥½è½¬ã€‚"],
                    "å®³æ€•": ["å®³æ€•æ˜¯äººä¹‹å¸¸æƒ…ï¼Œè¯•ç€ä¸“æ³¨äºç§¯æçš„äº‹æƒ…ã€‚", "æˆ‘åœ¨è¿™é‡Œé™ªä¼´æ‚¨ï¼Œä¸ç”¨å®³æ€•ã€‚"]
                };
                
                for (const [emotion, responses] of Object.entries(emotionalResponses)) {
                    this.quickResponseCache.set(emotion, responses);
                }
            }
            
            // ç”ŸæˆèŠå¤©ID
            generateChatId() {
                return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            // åŠ è½½èŠå¤©ä¼šè¯
            loadChatSessions() {
                try {
                    const saved = localStorage.getItem('kai_chat_sessions');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    return {};
                }
            }
            
            // ä¿å­˜èŠå¤©ä¼šè¯
            saveChatSessions() {
                try {
                    localStorage.setItem('kai_chat_sessions', JSON.stringify(this.chatSessions));
                    this.renderChatHistory();
                } catch (e) {
                    console.error('ä¿å­˜èŠå¤©ä¼šè¯å¤±è´¥:', e);
                 }
            }
            
            // åŠ è½½å­¦ä¹ åˆ°çš„çŸ¥è¯†
            loadKnowledge() {
                try {
                    const saved = localStorage.getItem('kai_knowledge');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    return {};
                }
            }
            
            // åŠ è½½ç”¨æˆ·è®°å¿†
            loadMemory() {
                try {
                    const saved = localStorage.getItem('kai_memory');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    return {};
                }
            }
            
            // åŠ è½½å¯¹è¯æ¨¡å¼
            loadConversationPatterns() {
                try {
                    const saved = localStorage.getItem('kai_patterns');
                    return saved ? JSON.parse(saved) : {
                        userPreferences: {},
                        topicInterests: {},
                        responsePreferences: {},
                        conversationStyle: "balanced"
                    };
                } catch (e) {
                    return {
                        userPreferences: {},
                        topicInterests: {},
                        responsePreferences: {},
                        conversationStyle: "balanced"
                    };
                }
            }
            
            // ä¿å­˜å­¦ä¹ åˆ°çš„çŸ¥è¯†
            saveKnowledge() {
                try {
                    localStorage.setItem('kai_knowledge', JSON.stringify(this.learnedKnowledge));
                } catch (e) {
                    console.error('ä¿å­˜çŸ¥è¯†å¤±è´¥:', e);
                }
            }
            
            // ä¿å­˜ç”¨æˆ·è®°å¿†
            saveMemory() {
                try {
                    localStorage.setItem('kai_memory', JSON.stringify(this.userMemory));
                } catch (e) {
                    console.error('ä¿å­˜è®°å¿†å¤±è´¥:', e);
                }
            }
            
            // ä¿å­˜å¯¹è¯æ¨¡å¼
            saveConversationPatterns() {
                try {
                    localStorage.setItem('kai_patterns', JSON.stringify(this.conversationPatterns));
                } catch (e) {
                    console.error('ä¿å­˜å¯¹è¯æ¨¡å¼å¤±è´¥:', e);
                }
            }
            
            // åˆ›å»ºæ–°èŠå¤©
            createNewChat() {
                this.currentChatId = this.generateChatId();
                this.chatSessions[this.currentChatId] = {
                    id: this.currentChatId,
                    title: "æ–°å¯¹è¯",
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                this.saveChatSessions();
                return this.currentChatId;
            }
            
            // åˆ‡æ¢åˆ°æŒ‡å®šèŠå¤©
            switchToChat(chatId) {
                if (this.chatSessions[chatId]) {
                    this.currentChatId = chatId;
                    return true;
                }
                return false;
            }
            
            // è·å–å½“å‰èŠå¤©
            getCurrentChat() {
                return this.chatSessions[this.currentChatId];
            }
            
            // è·å–æ‰€æœ‰èŠå¤©ä¼šè¯
            getAllChats() {
                return Object.values(this.chatSessions).sort((a, b) => 
                    new Date(b.updatedAt) - new Date(a.updatedAt)
                );
            }
            
            // æ›´æ–°èŠå¤©æ ‡é¢˜
            updateChatTitle(chatId, userMessage) {
                if (this.chatSessions[chatId] && this.chatSessions[chatId].title === "æ–°å¯¹è¯") {
                    const title = userMessage.length > 20 ? userMessage.substring(0, 20) + '...' : userMessage;
                    this.chatSessions[chatId].title = title;
                    this.chatSessions[chatId].updatedAt = new Date().toISOString();
                    this.saveChatSessions();
                }
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰èŠå¤©
            addMessageToCurrentChat(sender, content) {
                const chat = this.getCurrentChat();
                if (chat) {
                    chat.messages.push({
                        sender: sender,
                        content: content,
                        timestamp: new Date().toISOString()
                    });
                    chat.updatedAt = new Date().toISOString();
                    this.saveChatSessions();
                    
                    if (sender === 'user' && chat.messages.length === 1) {
                        this.updateChatTitle(this.currentChatId, content);
                    }
                }
            }
            
            // ç»ˆææé€Ÿæ„å›¾è¯†åˆ«
            understandIntent(userInput) {
                const input = userInput.toLowerCase().trim();
                
                // 1. æ£€æŸ¥å¿«é€Ÿç¼“å­˜ï¼ˆæœ€å¿«è·¯å¾„ï¼‰
                if (this.quickResponseCache.has(input)) {
                    return { type: 'instant', question: input };
                }
                
                // 2. æ£€æŸ¥ç›´æ¥åŒ¹é…
                for (const [question, answers] of Object.entries(this.instantKnowledge)) {
                    if (input === question.toLowerCase()) {
                        return { type: 'instant', question: question };
                    }
                }
                
                // 3. æ£€æŸ¥å­¦ä¹ åˆ°çš„çŸ¥è¯†
                if (this.learnedKnowledge[input]) {
                    return { type: 'learned', question: input, answer: this.learnedKnowledge[input] };
                }
                
                // 4. æ£€æŸ¥è®°å¿†
                for (const [key, value] of Object.entries(this.userMemory)) {
                    if (input.includes(key.toLowerCase())) {
                        return { type: 'memory', key, value };
                    }
                }
                
                // 5. æ£€æŸ¥ç‰¹æ®ŠæŒ‡ä»¤
                if (input.startsWith("è®°ä½ï¼š") || input.startsWith("è®°ä½:")) {
                    return { type: 'remember' };
                }
                
                if (input.startsWith("å­¦ä¹ ï¼š") || input.startsWith("å­¦ä¹ :")) {
                    return { type: 'learn' };
                }
                
                if (input.includes("æˆ‘çš„åå­—") || input.includes("å«æˆ‘")) {
                    return { type: 'name_extraction' };
                }
                
                // 6. æ£€æŸ¥æƒ…æ„Ÿè¯æ±‡
                const emotionalWords = ['å¼€å¿ƒ', 'é«˜å…´', 'å–œæ¬¢', 'çˆ±', 'è®¨åŒ', 'ç”Ÿæ°”', 'éš¾è¿‡', 'ä¼¤å¿ƒ', 'å®³æ€•', 'æ‹…å¿ƒ'];
                for (let i = 0; i < emotionalWords.length; i++) {
                    if (input.includes(emotionalWords[i])) {
                        return { type: 'emotional', emotion: emotionalWords[i] };
                    }
                }
                
                // 7. æ£€æŸ¥é—®é¢˜
                const questionWords = ['å—', 'å‘¢', 'ä»€ä¹ˆ', 'ä¸ºä»€ä¹ˆ', 'æ€ä¹ˆ', 'å¦‚ä½•', 'è°', 'å“ª', 'ä½•æ—¶'];
                for (let i = 0; i < questionWords.length; i++) {
                    if (input.includes(questionWords[i])) {
                        return { type: 'question' };
                    }
                }
                if (input.endsWith('?') || input.endsWith('ï¼Ÿ')) {
                    return { type: 'question' };
                }
                
                return { type: 'conversation' };
            }
            
            // ç»ˆææé€Ÿå›åº”ç”Ÿæˆ
            async generateResponse(userInput) {
                const startTime = performance.now();
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å½“å‰èŠå¤©
                this.addMessageToCurrentChat('user', userInput);
                
                const intent = this.understandIntent(userInput);
                
                let response;
                
                // æ ¹æ®æ„å›¾ç”Ÿæˆå›åº”
                switch (intent.type) {
                    case 'instant':
                        const instantResponses = this.quickResponseCache.get(intent.question) || 
                                               this.instantKnowledge[intent.question];
                        response = instantResponses[Math.floor(Math.random() * instantResponses.length)];
                        break;
                    
                    case 'learned':
                        response = intent.answer + " ğŸ§ ";
                        break;
                    
                    case 'memory':
                        response = `æˆ‘è®°å¾—ï¼š${intent.key} = ${intent.value} ğŸ’­`;
                        break;
                    
                    case 'remember':
                        response = this.processRememberCommand(userInput);
                        break;
                    
                    case 'learn':
                        response = this.processLearnCommand(userInput);
                        break;
                    
                    case 'name_extraction':
                        response = this.processNameExtraction(userInput);
                        break;
                    
                    case 'emotional':
                        response = this.generateEmotionalResponse(intent.emotion);
                        break;
                    
                    case 'question':
                        response = this.generateQuestionResponse(userInput);
                        break;
                    
                    case 'conversation':
                    default:
                        response = this.generateConversationResponse(userInput);
                        break;
                }
                
                // ä»å¯¹è¯ä¸­å­¦ä¹ 
                this.learnFromConversation(userInput, response);
                
                // æ·»åŠ AIå›åº”åˆ°å½“å‰èŠå¤©
                this.addMessageToCurrentChat('kai', response);
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                return { response, responseTime };
            }
            
            // å¤„ç†"è®°ä½"å‘½ä»¤
            processRememberCommand(userInput) {
                const parts = userInput.split(/[ï¼š:]/)[1].split('=');
                if (parts.length === 2) {
                    const key = parts[0].trim();
                    const value = parts[1].trim();
                    this.userMemory[key] = value;
                    this.saveMemory();
                    return `å·²è®°ä½ï¼š${key} = ${value} ğŸ’¾`;
                } else {
                    return "æ ¼å¼ï¼šè®°ä½ï¼šå…³é”®è¯=å€¼";
                }
            }
            
            // å¤„ç†"å­¦ä¹ "å‘½ä»¤
            processLearnCommand(userInput) {
                const parts = userInput.split(/[ï¼š:]/)[1].split('=>');
                if (parts.length === 2) {
                    const question = parts[0].trim();
                    const answer = parts[1].trim();
                    this.learnedKnowledge[question] = answer;
                    this.quickResponseCache.set(question, [answer]);
                    this.saveKnowledge();
                    return `å·²å­¦ä¹ ï¼šå½“é—®"${question}"æ—¶ï¼Œå›ç­”"${answer}" ğŸ“š`;
                } else {
                    return "æ ¼å¼ï¼šå­¦ä¹ ï¼šé—®é¢˜=>å›ç­”";
                }
            }
            
            // å¤„ç†åå­—æå–
            processNameExtraction(userInput) {
                const nameMatch = userInput.match(/(æˆ‘çš„åå­—æ˜¯|å«æˆ‘)(.+)/);
                if (nameMatch && nameMatch[2]) {
                    const name = nameMatch[2].trim();
                    this.userMemory['ç”¨æˆ·åå­—'] = name;
                    this.conversationPatterns.userPreferences['ç§°å‘¼'] = name;
                    this.saveMemory();
                    this.saveConversationPatterns();
                    return `å¥½çš„ï¼Œ${name}ï¼å·²è®°ä½æ‚¨çš„åå­—ã€‚å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼ğŸ‘‹`;
                }
                return "è¯·å‘Šè¯‰æˆ‘æ‚¨çš„åå­—ï¼šæˆ‘çš„åå­—æ˜¯XXX";
            }
            
            // ç”Ÿæˆæƒ…æ„Ÿå›åº”
            generateEmotionalResponse(emotion) {
                const emotionalResponses = {
                    "å¼€å¿ƒ": ["å¤ªå¥½äº†ï¼å¬åˆ°æ‚¨å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆé«˜å…´ï¼ğŸ˜Š", "çœŸæ£’ï¼ç»§ç»­ä¿æŒå¥½å¿ƒæƒ…ï¼"],
                    "é«˜å…´": ["å¤ªå¥½äº†ï¼å¬åˆ°æ‚¨å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆé«˜å…´ï¼ğŸ˜Š", "çœŸæ£’ï¼ç»§ç»­ä¿æŒå¥½å¿ƒæƒ…ï¼"],
                    "å–œæ¬¢": ["å¾ˆé«˜å…´æ‚¨å–œæ¬¢ï¼", "å¤ªå¥½äº†ï¼"],
                    "çˆ±": ["æ„Ÿå—åˆ°æ‚¨çš„çƒ­æƒ…ï¼", "è¿™å¾ˆæ£’ï¼"],
                    "è®¨åŒ": ["ç†è§£æ‚¨çš„ä¸å–œæ¬¢ã€‚", "æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„åå¥½ã€‚"],
                    "ç”Ÿæ°”": ["ç”Ÿæ°”æ˜¯æ­£å¸¸çš„æƒ…ç»ªï¼Œä½†è¯•ç€æ·±å‘¼å¸æ”¾æ¾ä¸€ä¸‹ã€‚", "æˆ‘ç†è§£æ‚¨æ„Ÿåˆ°ç”Ÿæ°”ï¼Œå¸Œæœ›äº‹æƒ…èƒ½å°½å¿«å¥½è½¬ã€‚"],
                    "éš¾è¿‡": ["æˆ‘ç†è§£æ‚¨çš„å¿ƒæƒ…ï¼Œå¦‚æœæ‚¨æ„¿æ„åˆ†äº«ï¼Œæˆ‘å¾ˆä¹æ„å€¾å¬ã€‚", "æœ‰æ—¶å€™ç¡®å®ä¼šæ„Ÿåˆ°éš¾è¿‡ï¼Œæˆ‘åœ¨è¿™é‡Œæ”¯æŒæ‚¨ã€‚"],
                    "ä¼¤å¿ƒ": ["æˆ‘ç†è§£æ‚¨çš„å¿ƒæƒ…ï¼Œå¦‚æœæ‚¨æ„¿æ„åˆ†äº«ï¼Œæˆ‘å¾ˆä¹æ„å€¾å¬ã€‚", "æœ‰æ—¶å€™ç¡®å®ä¼šæ„Ÿåˆ°éš¾è¿‡ï¼Œæˆ‘åœ¨è¿™é‡Œæ”¯æŒæ‚¨ã€‚"],
                    "å®³æ€•": ["å®³æ€•æ˜¯äººä¹‹å¸¸æƒ…ï¼Œè¯•ç€ä¸“æ³¨äºç§¯æçš„äº‹æƒ…ã€‚", "æˆ‘åœ¨è¿™é‡Œé™ªä¼´æ‚¨ï¼Œä¸ç”¨å®³æ€•ã€‚"],
                    "æ‹…å¿ƒ": ["æ‹…å¿ƒæ˜¯æ­£å¸¸çš„ï¼Œä½†è¯•ç€ä¸è¦è¿‡åº¦æ‹…å¿§ã€‚", "æˆ‘ç†è§£æ‚¨çš„æ‹…å¿ƒï¼Œå¸Œæœ›ä¸€åˆ‡é¡ºåˆ©ã€‚"]
                };
                
                return emotionalResponses[emotion] 
                    ? emotionalResponses[emotion][Math.floor(Math.random() * emotionalResponses[emotion].length)]
                    : "æˆ‘ç†è§£æ‚¨çš„æ„Ÿå—ã€‚";
            }
            
            // ç”Ÿæˆé—®é¢˜å›åº”
            generateQuestionResponse(userInput) {
                // å°è¯•ä»å·²æœ‰çŸ¥è¯†ä¸­å¯»æ‰¾ç­”æ¡ˆ
                for (const [question, answer] of Object.entries(this.learnedKnowledge)) {
                    if (userInput.includes(question)) {
                        return answer;
                    }
                }
                
                // å¦‚æœä¸çŸ¥é“ç­”æ¡ˆï¼Œç”Ÿæˆå­¦ä¹ æ€§å›åº”
                return `å…³äº"${userInput}"ï¼Œæˆ‘è¿˜åœ¨å­¦ä¹ ä¸­ã€‚æ‚¨èƒ½å‘Šè¯‰æˆ‘ç­”æ¡ˆå—ï¼Ÿä½¿ç”¨"å­¦ä¹ ï¼š${userInput}=>ç­”æ¡ˆ"æ¥æ•™æˆ‘ã€‚`;
            }
            
            // ç”Ÿæˆå¯¹è¯å›åº”
            generateConversationResponse(userInput) {
                // æ€è€ƒæ€§å›åº”
                const thoughtfulResponses = [
                    `å…³äº"${userInput}"ï¼Œè¿™æ˜¯ä¸ªæœ‰è¶£çš„è¯é¢˜ï¼`,
                    "æˆ‘ç†è§£æ‚¨è¯´çš„å†…å®¹ã€‚",
                    "è°¢è°¢åˆ†äº«ï¼",
                    "å¾ˆæœ‰æ„æ€çš„è§‚ç‚¹ï¼",
                    `æˆ‘æ³¨æ„åˆ°æ‚¨åœ¨è®¨è®º"${userInput}"ã€‚`,
                    `å¯¹äº"${userInput}"ï¼Œæ‚¨æœ‰ä»€ä¹ˆç‰¹åˆ«çš„çœ‹æ³•å—ï¼Ÿ`,
                    "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ·±åº¦ï¼"
                ];
                
                // æ·»åŠ ä¸€äº›ä¸ªæ€§åŒ–å›åº”
                if (this.userMemory['ç”¨æˆ·åå­—']) {
                    thoughtfulResponses.push(
                        `${this.userMemory['ç”¨æˆ·åå­—']}ï¼Œå…³äºè¿™ä¸ªè¯é¢˜ï¼Œæˆ‘å¾ˆæƒ³å¬å¬æ‚¨çš„æƒ³æ³•ï¼`,
                        `æ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„äº¤æµï¼Œ${this.userMemory['ç”¨æˆ·åå­—']}ï¼Œæˆ‘è§‰å¾—æ‚¨å¯èƒ½ä¼šå¯¹è¿™ä¸ªè¯é¢˜æ„Ÿå…´è¶£...`
                    );
                }
                
                return thoughtfulResponses[Math.floor(Math.random() * thoughtfulResponses.length)];
            }
            
            // ä»å¯¹è¯ä¸­å­¦ä¹ 
            learnFromConversation(userInput, aiResponse) {
                // æå–å…³é”®è¯
                const words = userInput.split(/\s+/);
                words.forEach(word => {
                    if (word.length > 1) {
                        this.conversationPatterns.topicInterests[word] = 
                            (this.conversationPatterns.topicInterests[word] || 0) + 1;
                    }
                });
                
                // å­¦ä¹ å›åº”æ¨¡å¼
                if (aiResponse.length > 5 && userInput.length > 3) {
                    if (!this.learnedKnowledge[userInput]) {
                        this.learnedKnowledge[userInput] = aiResponse;
                        this.saveKnowledge();
                    }
                }
                
                this.saveConversationPatterns();
            }
            
            // æ¸²æŸ“èŠå¤©å†å²
            renderChatHistory() {
                const chatHistoryElement = document.getElementById('chat-history');
                const chats = this.getAllChats();
                
                if (chats.length === 0) {
                    chatHistoryElement.innerHTML = '<div class="empty-state">æš‚æ— èŠå¤©è®°å½•</div>';
                    return;
                }
                
                let html = '';
                chats.forEach(chat => {
                    const isActive = chat.id === this.currentChatId;
                    const date = new Date(chat.updatedAt).toLocaleDateString('zh-CN', {
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    html += `
                        <div class="chat-history-item ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                            <div class="title">${chat.title}</div>
                            <div class="date">${date}</div>
                        </div>
                    `;
                });
                
                chatHistoryElement.innerHTML = html;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.chat-history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const chatId = item.getAttribute('data-chat-id');
                        if (chatId !== this.currentChatId) {
                            this.switchToChat(chatId);
                            this.renderChatHistory();
                            renderChatMessages();
                        }
                    });
                });
            }
        }

        // åˆå§‹åŒ–ç»ˆææé€Ÿç‰ˆK(ai)
        const kai = new UltimateKaiAI();
        
        // DOMå…ƒç´ 
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const emptyState = document.getElementById('empty-state');
        const speedIndicator = document.getElementById('speed-indicator');
        
        // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
        function renderChatMessages() {
            const chat = kai.getCurrentChat();
            chatContainer.innerHTML = '';
            
            if (chat.messages.length === 0) {
                emptyState.style.display = 'flex';
            } else {
                emptyState.style.display = 'none';
                
                chat.messages.forEach(message => {
                    addMessage(message.content, message.sender, false);
                });
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        // å‘é€æ¶ˆæ¯å‡½æ•°
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // éšè—ç©ºçŠ¶æ€
            emptyState.style.display = 'none';
            
            // ç¦ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
            userInput.disabled = true;
            sendBtn.disabled = true;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            addMessage(message, 'user');
            userInput.value = '';
            
            // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // è·å–AIå›åº”
            const { response, responseTime } = await kai.generateResponse(message);
            
            // éšè—"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
            typingIndicator.style.display = 'none';
            
            // æ·»åŠ AIå›åº”åˆ°èŠå¤©ç•Œé¢
            const aiMessageElement = addMessage(response, 'kai');
            
            // æ˜¾ç¤ºå“åº”æ—¶é—´
            speedIndicator.textContent = `å“åº”æ—¶é—´: ${responseTime}ms`;
            speedIndicator.style.display = 'block';
            setTimeout(() => {
                speedIndicator.style.display = 'none';
            }, 3000);
            
            // å¦‚æœæ˜¯å­¦ä¹ åˆ°çš„å†…å®¹ï¼Œæ·»åŠ å­¦ä¹ æŒ‡ç¤ºå™¨
            if (response.includes("ğŸ§ ") || response.includes("å­¦ä¹ ") || response.includes("è®°ä½")) {
                const learningIndicator = document.createElement('div');
                learningIndicator.className = 'learning-indicator';
                learningIndicator.textContent = 'K(ai) ä»è¿™æ¬¡å¯¹è¯ä¸­å­¦åˆ°äº†æ–°çŸ¥è¯†';
                aiMessageElement.appendChild(learningIndicator);
            }
            
            // é‡æ–°å¯ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
            
            // æ›´æ–°èŠå¤©å†å²
            kai.renderChatHistory();
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(text, sender, animate = true) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message`;
            messageElement.textContent = text;
            
            if (animate) {
                messageElement.style.animation = 'fadeIn 0.2s ease';
            }
            
            chatContainer.appendChild(messageElement);
            return messageElement;
        }
        
        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        newChatBtn.addEventListener('click', () => {
            kai.createNewChat();
            kai.renderChatHistory();
            renderChatMessages();
        });
        
        // åˆå§‹åŒ–
        kai.renderChatHistory();
        renderChatMessages();
        
        // åˆå§‹èšç„¦è¾“å…¥æ¡†
        userInput.focus();
    </script>
</body>
</html>
